service: nadro-mentoria-api

frameworkVersion: '4'

provider:
  name: aws
  runtime: nodejs18.x
  region: ${opt:region, 'us-east-1'}
  stage: ${opt:stage, 'dev'}
  profile: ${self:custom.awsProfile.${self:provider.stage}, 'default'}
  timeout: ${self:custom.timeout.${self:provider.stage}, 30}
  memorySize: ${self:custom.memorySize.${self:provider.stage}, 512}
  stackTags:
    Environment: ${self:provider.stage}
    Project: NadroMentoria
  environment:
    NODE_ENV: ${self:provider.stage}
    COGNITO_USER_POOL_ID: !Ref CognitoUserPool
    COGNITO_CLIENT_ID: !Ref CognitoUserPoolClient
    CONSULTAS_TABLE: NadroMentoria-Consultas-${self:provider.stage}
    USUARIOS_TABLE: NadroMentoria-Usuarios-${self:provider.stage}
    CAPACITACIONES_TABLE: NadroMentoria-Capacitaciones-${self:provider.stage}
    ENTREVISTAS_TABLE: NadroMentoria-Entrevistas-${self:provider.stage}
    ACERCAMIENTOS_TABLE: NadroMentoria-Acercamientos-${self:provider.stage}
  
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - dynamodb:Query
            - dynamodb:Scan
            - dynamodb:GetItem
            - dynamodb:PutItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
          Resource:
            - "arn:aws:dynamodb:${self:provider.region}:*:table/NadroMentoria-Consultas-${self:provider.stage}"
            - "arn:aws:dynamodb:${self:provider.region}:*:table/NadroMentoria-Usuarios-${self:provider.stage}"
            - "arn:aws:dynamodb:${self:provider.region}:*:table/NadroMentoria-Capacitaciones-${self:provider.stage}"
            - "arn:aws:dynamodb:${self:provider.region}:*:table/NadroMentoria-Entrevistas-${self:provider.stage}"
            - "arn:aws:dynamodb:${self:provider.region}:*:table/NadroMentoria-Acercamientos-${self:provider.stage}"
        - Effect: Allow
          Action:
            - cognito-idp:AdminGetUser
            - cognito-idp:AdminListGroupsForUser
            - cognito-idp:ListUsers
            - cognito-idp:AdminAddUserToGroup
            - cognito-idp:AdminRemoveUserFromGroup
            - cognito-idp:AdminCreateUser
            - cognito-idp:AdminUpdateUserAttributes
            - cognito-idp:AdminDisableUser
            - cognito-idp:AdminEnableUser
            - cognito-idp:AdminSetUserPassword
          Resource:
            - !GetAtt CognitoUserPool.Arn
  
  # Configuración del HTTP API con Cognito Authorizer
  httpApi:
    disableDefaultEndpoint: false
    cors:
      allowedOrigins:
        - '*'
      allowedHeaders:
        - Content-Type
        - Authorization
        - X-Amz-Date
        - X-Api-Key
        - X-Amz-Security-Token
      allowedMethods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
      allowCredentials: false
    authorizers:
      cognitoAuthorizer:
        type: jwt
        identitySource: $request.header.Authorization
        issuerUrl: !Sub https://cognito-idp.${AWS::Region}.amazonaws.com/${CognitoUserPool}
        audience:
          - !Ref CognitoUserPoolClient
    shouldStartNameWithService: true

functions:
  api:
    handler: src/lambda.handler
    events:
      # Ruta pública - Home
      - httpApi:
          path: /
          method: GET
      # Ruta pública - Health Check (para monitoreo)
      - httpApi:
          path: /api/health
          method: GET
      # Rutas públicas - OPTIONS (Preflight CORS - requerido por el navegador)
      - httpApi:
          path: /api/{proxy+}
          method: OPTIONS
      - httpApi:
          path: /api
          method: OPTIONS
      # Rutas protegidas con Cognito (TODO lo demás requiere autenticación)
      - httpApi:
          path: /api/{proxy+}
          method: ANY
          authorizer:
            name: cognitoAuthorizer
      - httpApi:
          path: /api
          method: ANY
          authorizer:
            name: cognitoAuthorizer

plugins:
  - serverless-offline

custom:
  serverless-offline:
    httpPort: 3001
  
  # Configuración de AWS Profile por ambiente
  awsProfile:
    qa: 'qa-mentoria'        # QA en tu cuenta
    dev: 'dev-mentoria'      # DEV en tu cuenta
    prod: 'prod-mentoria'    # PROD en tu cuenta
  
  # Configuración específica por ambiente
  timeout:
    dev: 29        # 29 segundos para dejar margen con HTTP API (límite 30s)
    prod: 29        # 29 segundos para dejar margen con HTTP API (límite 30s)
  
  memorySize:
    dev: 512       # QA (actual)
    prod: 2048     # PRODUCCIÓN (nuevo)

# Configuración de seguridad adicional
resources:
  Conditions:
    IsProd:
      Fn::Equals:
        - ${self:provider.stage}
        - prod
    IsNotProd:
      Fn::Not:
        - Fn::Equals:
            - ${self:provider.stage}
            - prod
  Resources:
    # Cognito User Pool
    CognitoUserPool:
      Type: AWS::Cognito::UserPool
      Properties:
        UserPoolName: NadroMentoria-UserPool-${self:provider.stage}
        UsernameAttributes:
          - email
        AutoVerifiedAttributes:
          - email
        Schema:
          - Name: email
            Required: true
            Mutable: false
          - Name: name
            Required: true
            Mutable: true
        Policies:
          PasswordPolicy:
            MinimumLength: 8
            RequireUppercase: true
            RequireLowercase: true
            RequireNumbers: true
            RequireSymbols: false
        MfaConfiguration: OPTIONAL
        EnabledMfas:
          - SOFTWARE_TOKEN_MFA
        AccountRecoverySetting:
          RecoveryMechanisms:
            - Name: verified_email
              Priority: 1
        UserPoolTags:
          Environment: ${self:provider.stage}
          Project: NadroMentoria

    # Cognito User Pool Client
    CognitoUserPoolClient:
      Type: AWS::Cognito::UserPoolClient
      Properties:
        ClientName: NadroMentoria-Client-${self:provider.stage}
        UserPoolId: !Ref CognitoUserPool
        GenerateSecret: false
        ExplicitAuthFlows:
          - ALLOW_USER_PASSWORD_AUTH
          - ALLOW_REFRESH_TOKEN_AUTH
          - ALLOW_USER_SRP_AUTH
        PreventUserExistenceErrors: ENABLED
        AccessTokenValidity: 1
        IdTokenValidity: 1
        RefreshTokenValidity: 30
        TokenValidityUnits:
          AccessToken: hours
          IdToken: hours
          RefreshToken: days

    # Cognito User Groups (Roles)
    CognitoUserPoolGroupAdmin:
      Type: AWS::Cognito::UserPoolGroup
      Properties:
        GroupName: admin
        Description: Administradores - Acceso completo al dashboard y consultas
        UserPoolId: !Ref CognitoUserPool
        Precedence: 1

    CognitoUserPoolGroupMentor:
      Type: AWS::Cognito::UserPoolGroup
      Properties:
        GroupName: mentor
        Description: Mentores - Solo acceso a consultas
        UserPoolId: !Ref CognitoUserPool
        Precedence: 2

    # DynamoDB Tables
    ConsultasTable:
      Condition: IsNotProd
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: NadroMentoria-Consultas-${self:provider.stage}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
          - AttributeName: createdAt
            AttributeType: S
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: CreatedAtIndex
            KeySchema:
              - AttributeName: createdAt
                KeyType: HASH
            Projection:
              ProjectionType: ALL
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Project
            Value: NadroMentoria

    UsuariosTable:
      Condition: IsNotProd
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: NadroMentoria-Usuarios-${self:provider.stage}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: email
            AttributeType: S
        KeySchema:
          - AttributeName: email
            KeyType: HASH
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Project
            Value: NadroMentoria

    CapacitacionesTable:
      Condition: IsNotProd
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: NadroMentoria-Capacitaciones-${self:provider.stage}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
          - AttributeName: createdAt
            AttributeType: S
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: CreatedAtIndex
            KeySchema:
              - AttributeName: createdAt
                KeyType: HASH
            Projection:
              ProjectionType: ALL
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Project
            Value: NadroMentoria

    EntrevistasTable:
      Condition: IsNotProd
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: NadroMentoria-Entrevistas-${self:provider.stage}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
          - AttributeName: createdAt
            AttributeType: S
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: CreatedAtIndex
            KeySchema:
              - AttributeName: createdAt
                KeyType: HASH
            Projection:
              ProjectionType: ALL
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Project
            Value: NadroMentoria

    AcercamientosTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: NadroMentoria-Acercamientos-${self:provider.stage}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
          - AttributeName: createdAt
            AttributeType: S
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: CreatedAtIndex
            KeySchema:
              - AttributeName: createdAt
                KeyType: HASH
            Projection:
              ProjectionType: ALL
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Project
            Value: NadroMentoria
  
  Outputs:
    CognitoUserPoolId:
      Value: !Ref CognitoUserPool
      Description: ID del User Pool de Cognito
      Export:
        Name: NadroMentoria-UserPoolId-${self:provider.stage}
    
    CognitoUserPoolClientId:
      Value: !Ref CognitoUserPoolClient
      Description: ID del Cliente de Cognito
      Export:
        Name: NadroMentoria-UserPoolClientId-${self:provider.stage}
    
    CognitoUserPoolArn:
      Value: !GetAtt CognitoUserPool.Arn
      Description: ARN del User Pool de Cognito
      Export:
        Name: NadroMentoria-UserPoolArn-${self:provider.stage}
